<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="切莫停下前进的脚步">
<meta property="og:type" content="website">
<meta property="og:title" content="xixijiang的主页">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="xixijiang的主页">
<meta property="og:description" content="切莫停下前进的脚步">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="xixijiang的主页">
<meta name="twitter:description" content="切莫停下前进的脚步">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>xixijiang的主页</title>
  














</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xixijiang的主页</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/23/ip、域名关系/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xixijiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xixijiang的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/23/ip、域名关系/" itemprop="url">ip、域名关系</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-23T14:55:20+08:00">
                2019-08-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>现象：</p>
<ol>
<li>base.xiaojukeji.com不能通过ip访问（参考第3、6点）</li>
<li>base-test.xiaojukeji.com可以通过ip访问，也可以访问子系统，访问子系统时会自动转成域名。（参考第4点）</li>
<li>base.xiaojukeji.com不需要绑定host访问，base-pre.xiaojukeji.com需要绑定host</li>
</ol>
<p>问题抽象：</p>
<ol>
<li>为什么有的网站可以通过ip访问，有的只能通过域名访问？</li>
<li>为什么几个不同的网站解析后ip是一样的？</li>
<li>微服务是如何实现的？</li>
</ol>
<p>原理：</p>
<ol>
<li>Ip、域名、url关系：一个ip可以对应一个或多个域名，url里协议后面//到第一个/之间是域名，ip与域名绑定关系需要申请，申请后才可以通过域名访问。没有绑定域名的ip，如果需要通过域名访问，则需要绑定host。</li>
<li>一个ip对应多个域名实现方式：虚拟host、反向代理，我们base平台使用的是虚拟host</li>
<li>如果一个ip对应多个域名，那么通过ip访问就会不知道到底使用哪个服务</li>
<li>Nginx哪个选项是配置禁止ip访问的？listen 80 default; return 500;</li>
<li>Nginx通过哪个选项配置通过ip访问时，自动转成域名？通过ip访问时，如果不带端口号，默认访问的是80端口，所以nginx可以监听80端口，并通过rewrite更改url</li>
<li>Nginx配置多个server就相当于多个虚拟host吗？是的</li>
<li>线上nginx配置没有第3点禁止ip访问的配置项，为啥还不能通过ip访问？麒麟网关做了配置，把80端口代理到8080。</li>
<li>线上nginx配置没有80，只有8080，那在通过域名访问时为什么还能正常？麒麟网关做了配置，把80端口代理到8080。</li>
<li>麒麟网关做了哪些事情？不知道 暂时不去了解</li>
</ol>
<p>参考：<br><a href="https://blog.csdn.net/gui951753/article/details/83070180" target="_blank" rel="noopener">https://blog.csdn.net/gui951753/article/details/83070180</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/22/vue源码解析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xixijiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xixijiang的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/22/vue源码解析/" itemprop="url">vue源码解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-22T16:56:20+08:00">
                2019-06-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/11/vue-loader源码解析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xixijiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xixijiang的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/11/vue-loader源码解析/" itemprop="url">vue-loader源码解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-11T22:47:33+08:00">
                2019-06-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><h2 id="vue-loader基本知识"><a href="#vue-loader基本知识" class="headerlink" title="vue-loader基本知识"></a>vue-loader基本知识</h2><blockquote>
<p>vue-loader作用：允许你以一种名为单文件组件（SFC）的格式撰写Vue组件</p>
</blockquote>
<ol>
<li><p>block（块）：vue组件里包含<code>template</code>、<code>script</code>、<code>style</code>、<code>custom blocks</code>这几部分，我们称之为“块”。</p>
</li>
<li><p>一个vue组件里可以包含多个<code>style</code>块、<code>custom</code>块。</p>
</li>
<li><p>每个块都可以使用不同的loader来处理，比如：</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;template lang=<span class="string">"pug"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&lt;script type=<span class="string">"text/vbscript"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&lt;style lang=<span class="string">"scss"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&lt;style lang=<span class="string">"less"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&lt;docs lang=<span class="string">"xxx"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">docs</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&lt;foo&gt;<span class="xml"><span class="tag">&lt;/<span class="name">foo</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>webpack里可以设置相应的loader来处理这些块，比如<code>pug-plain-loader</code>、<code>sass-loader</code>等。</p>
<ol start="4">
<li>支持函数式组件</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template functional&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123; props.foo &#125;&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br></pre></td></tr></table></figure>
<h2 id="webpack-loader基本知识"><a href="#webpack-loader基本知识" class="headerlink" title="webpack loader基本知识"></a>webpack loader基本知识</h2><p>vue-loader与webpack loader密切相关，我们首先看一下webpack loader的执行过程。</p>
<p>每个loader上都可以有一个<code>.pitch</code>方法，loader的处理过程分为两个阶段，pitch阶段和normal执行阶段：</p>
<p>第一步先进行pitch阶段：会先按顺序执行每个loader的pitch方法；</p>
<p>第二步按相反顺序进行normal执行阶段</p>
<p>如果loader的pitch方法有返回值，则直接掉头往相反顺序执行。参考官网例子(<a href="https://webpack.docschina.org/api/loaders/#%E8%B6%8A%E8%BF%87-loader-pitching-loader-" target="_blank" rel="noopener">pitching loader</a>)：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        use: [</span><br><span class="line">          <span class="string">'a-loader'</span>,</span><br><span class="line">          <span class="string">'b-loader'</span>,</span><br><span class="line">          <span class="string">'c-loader'</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面例子中各个loader的执行顺序如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|- a-loader `pitch`</span><br><span class="line">  |- b-loader `pitch`</span><br><span class="line">    |- c-loader `pitch`</span><br><span class="line">      |- requested module is picked up as a dependency</span><br><span class="line">    |- c-loader normal execution</span><br><span class="line">  |- b-loader normal execution</span><br><span class="line">|- a-loader normal execution</span><br></pre></td></tr></table></figure>
<p>如果b-loader返回了内容，则执行顺序如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|- a-loader `pitch`</span><br><span class="line">  |- b-loader `pitch` returns a module</span><br><span class="line">|- a-loader normal execution</span><br></pre></td></tr></table></figure>
<h1 id="vue-loader在webpack流程中的位置"><a href="#vue-loader在webpack流程中的位置" class="headerlink" title="vue-loader在webpack流程中的位置"></a>vue-loader在webpack流程中的位置</h1><p><img src="https://github.com/xixizhangfe/markdownImages/blob/master/vue-loader%E5%9C%A8webpack%E4%B8%AD%E7%9A%84%E4%BD%8D%E7%BD%AE.jpg?raw=true" alt="vue-loader在webpack流程中的位置"></p>
<p>图中黄色部分就是vue-loader所涉及的内容，也就是我们这篇文章要分析的。</p>
<h1 id="输入与输出"><a href="#输入与输出" class="headerlink" title="输入与输出"></a>输入与输出</h1><p>接下来，我们将通过一个例子，来看vue-loader是怎么工作的(这个例子来自vue-loader/example/)。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> Foo <span class="keyword">from</span> <span class="string">'./source.vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(Foo)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// source.vue</span></span><br><span class="line">&lt;template lang=<span class="string">"pug"</span>&gt;</span><br><span class="line">  div(ok)</span><br><span class="line">    h1(:<span class="class"><span class="keyword">class</span></span>=<span class="string">"$style.red"</span>) hello</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">export default &#123;</span></span><br><span class="line"><span class="regexp">  data () &#123;</span></span><br><span class="line"><span class="regexp">    return &#123;</span></span><br><span class="line"><span class="regexp">      msg: 'fesfff'</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style <span class="built_in">module</span>&gt;</span><br><span class="line">.red &#123;</span><br><span class="line">  color: red;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/style&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;foo&gt;</span></span><br><span class="line"><span class="regexp">export default comp =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  console.log(comp.options.data())</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>foo&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> VueLoaderPlugin = <span class="built_in">require</span>(<span class="string">'../lib/plugin'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  devtool: <span class="string">'source-map'</span>,</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  entry: path.resolve(__dirname, <span class="string">'./main.js'</span>),</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'bundle.js'</span>,</span><br><span class="line">    publicPath: <span class="string">'/dist/'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    stats: <span class="string">"minimal"</span>,</span><br><span class="line">    contentBase: __dirname,</span><br><span class="line">    writeToDisk: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">        loader: <span class="string">'vue-loader'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        resourceQuery: <span class="regexp">/blockType=foo/</span>,</span><br><span class="line">        loader: <span class="string">'babel-loader'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.pug$/</span>,</span><br><span class="line">        oneOf: [</span><br><span class="line">          &#123;</span><br><span class="line">            resourceQuery: <span class="regexp">/^\?vue/</span>,</span><br><span class="line">            use: [<span class="string">'pug-plain-loader'</span>]</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            use: [<span class="string">'raw-loader'</span>, <span class="string">'pug-plain-loader'</span>]</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        oneOf: [</span><br><span class="line">          &#123;</span><br><span class="line">            resourceQuery: <span class="regexp">/module/</span>,</span><br><span class="line">            use: [</span><br><span class="line">              <span class="string">'vue-style-loader'</span>,</span><br><span class="line">              &#123;</span><br><span class="line">                loader: <span class="string">'css-loader'</span>,</span><br><span class="line">                options: &#123;</span><br><span class="line">                  modules: <span class="literal">true</span>,</span><br><span class="line">                  localIdentName: <span class="string">'[local]_[hash:base64:8]'</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            use: [</span><br><span class="line">              <span class="string">'vue-style-loader'</span>,</span><br><span class="line">              <span class="string">'css-loader'</span></span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="string">'vue-style-loader'</span>,</span><br><span class="line">          <span class="string">'css-loader'</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'sass-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              data: <span class="string">'$color: red;'</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  resolveLoader: &#123;</span><br><span class="line">    alias: &#123;</span><br><span class="line">      <span class="string">'vue-loader'</span>: <span class="built_in">require</span>.resolve(<span class="string">'../lib'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> VueLoaderPlugin()</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于上述例子，vue-loader的输出结果是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// template</span></span><br><span class="line">  <span class="comment">// 来自 import &#123; render, staticRenderFns &#125; from "./source.vue?vue&amp;type=template&amp;id=27e4e96e&amp;lang=pug&amp;" 的结果</span></span><br><span class="line">  <span class="keyword">var</span> render = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _vm = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">var</span> _h = _vm.$createElement</span><br><span class="line">    <span class="keyword">var</span> _c = _vm._self._c || _h</span><br><span class="line">    <span class="keyword">return</span> _c(</span><br><span class="line">      <span class="string">"div"</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        attrs: &#123;</span><br><span class="line">          ok: <span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      [</span><br><span class="line">        _c(</span><br><span class="line">          <span class="string">"h1"</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            class: _vm.$style.red</span><br><span class="line">          &#125;,</span><br><span class="line">        [_vm._v(<span class="string">"hello"</span>)</span><br><span class="line">      ])</span><br><span class="line">    ])</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> staticRenderFns = []</span><br><span class="line"></span><br><span class="line">  render._withStripped = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// script</span></span><br><span class="line">  <span class="comment">// 来自 import script from "./source.vue?vue&amp;type=script&amp;lang=js&amp;" 的结果</span></span><br><span class="line">  <span class="keyword">var</span> script = &#123;</span><br><span class="line">    data () &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        msg: <span class="string">'fesfff'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// style</span></span><br><span class="line">  <span class="comment">// 来自 import style0 from "./source.vue?vue&amp;type=style&amp;index=0&amp;module=true&amp;lang=css&amp;" 的结果</span></span><br><span class="line">  .red &#123;</span><br><span class="line">    color: red;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注入style 及 style热加载</span></span><br><span class="line">  <span class="keyword">var</span> cssModules = &#123;&#125;</span><br><span class="line">    <span class="keyword">var</span> disposed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">injectStyles</span> (<span class="params">context</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (disposed) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      cssModules[<span class="string">"$style"</span>] = (style0.locals || style0)</span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, <span class="string">"$style"</span>, &#123;</span><br><span class="line">        configurable: <span class="literal">true</span>,</span><br><span class="line">        get: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> cssModules[<span class="string">"$style"</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">module</span>.hot &amp;&amp; <span class="built_in">module</span>.hot.dispose(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">      disposed = <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">module</span>.hot &amp;&amp; <span class="built_in">module</span>.hot.accept([<span class="string">"./source.vue?vue&amp;type=style&amp;index=0&amp;module=true&amp;lang=css&amp;"</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> oldLocals = cssModules[<span class="string">"$style"</span>]</span><br><span class="line">      <span class="keyword">if</span> (oldLocals) &#123;</span><br><span class="line">        <span class="keyword">var</span> newLocals = <span class="built_in">require</span>(<span class="string">"./source.vue?vue&amp;type=style&amp;index=0&amp;module=true&amp;lang=css&amp;"</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">JSON</span>.stringify(newLocals) !== <span class="built_in">JSON</span>.stringify(oldLocals)) &#123;</span><br><span class="line">          cssModules[<span class="string">"$style"</span>] = newLocals</span><br><span class="line">          <span class="built_in">require</span>(<span class="string">"/Users/zhangxixi/knowledge collect/vue-loader/node_modules/_vue-hot-reload-api@2.3.3@vue-hot-reload-api/dist/index.js"</span>).rerender(<span class="string">"27e4e96e"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// normalize component</span></span><br><span class="line">    <span class="keyword">import</span> normalizer <span class="keyword">from</span> <span class="string">"!../lib/runtime/componentNormalizer.js"</span></span><br><span class="line">    <span class="keyword">var</span> component = normalizer(</span><br><span class="line">      script,</span><br><span class="line">      render,</span><br><span class="line">      staticRenderFns,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      injectStyles,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      <span class="literal">null</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// custom blocks</span></span><br><span class="line">    <span class="comment">// 来自 import block0 from "./source.vue?vue&amp;type=custom&amp;index=0&amp;blockType=foo" 的结果</span></span><br><span class="line">    <span class="keyword">var</span> block0 = <span class="function"><span class="params">comp</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(comp.options.data())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> block0 === <span class="string">'function'</span>) block0(component)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hot reload</span></span><br><span class="line">    <span class="comment">// script 和 template的热加载</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">module</span>.hot) &#123;</span><br><span class="line">      <span class="keyword">var</span> api = <span class="built_in">require</span>(<span class="string">"/Users/zhangxixi/knowledge collect/vue-loader/node_modules/_vue-hot-reload-api@2.3.3@vue-hot-reload-api/dist/index.js"</span>)</span><br><span class="line">      api.install(<span class="built_in">require</span>(<span class="string">'vue'</span>))</span><br><span class="line">      <span class="keyword">if</span> (api.compatible) &#123;</span><br><span class="line">        <span class="built_in">module</span>.hot.accept()</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">module</span>.hot.data) &#123;</span><br><span class="line">          api.createRecord(<span class="string">'27e4e96e'</span>, component.options)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          api.reload(<span class="string">'27e4e96e'</span>, component.options)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">module</span>.hot.accept(<span class="string">"./source.vue?vue&amp;type=template&amp;id=27e4e96e&amp;lang=pug&amp;"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          api.rerender(<span class="string">'27e4e96e'</span>, &#123;</span><br><span class="line">            render: render,</span><br><span class="line">            staticRenderFns: staticRenderFns</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    component.options.__file = <span class="string">"example/source.vue"</span></span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">default</span> component.exports</span><br></pre></td></tr></table></figure>
<h1 id="源码结构"><a href="#源码结构" class="headerlink" title="源码结构"></a>源码结构</h1><p>首先看一下vue-loader源码结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vue-loader/lib/</span><br><span class="line">  │</span><br><span class="line">  ├─── codegen/</span><br><span class="line">  │      ├─── customBlock.js/      生成custom block的request</span><br><span class="line">  │      ├─── hotReload.js/        生成热加载的代码</span><br><span class="line">  │      ├─── styleInjection.js/   生成style的request</span><br><span class="line">  │      ├─── utils.js/            工具函数</span><br><span class="line">  ├─── loaders/   vue-loader内部定义的loaders</span><br><span class="line">  │      ├─── pitcher.js/          pitcher-loader，将所有的单文件组件里的block请求拦截并转成合适的请求</span><br><span class="line">  │      ├─── stylePostLoader.js/  style-post-loader， 处理scoped css的loader</span><br><span class="line">  │      ├─── templateLoader.js/   template-loader，编译 html 模板字符串，生成 render/staticRenderFns 函数</span><br><span class="line">  ├─── runtime/</span><br><span class="line">  │      ├─── componentNormalizer.js/  将组件标准化</span><br><span class="line">  ├─── index.d.ts/</span><br><span class="line">  ├─── index.js/    vue-loader的核心代码</span><br><span class="line">  ├─── plugin.js/   vue-loader-plugin的核心代码</span><br><span class="line">  ├─── select.js/   根据不同query类型（script、template等）传递相应的content、map给下一个loader</span><br></pre></td></tr></table></figure>
<h1 id="vue-loader-plugin"><a href="#vue-loader-plugin" class="headerlink" title="vue-loader-plugin"></a>vue-loader-plugin</h1><p>在webpack开始执行后，会先合并webpack.config里的配置，接着实例化compiler，然后就去挨个执行所有plugin的apply方法。请看webpack这部分源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack/lib/webpack.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Compiler = <span class="built_in">require</span>(<span class="string">"./Compiler"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="function">(<span class="params">options, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  options = <span class="keyword">new</span> WebpackOptionsDefaulter().process(options) <span class="comment">// 初始化 webpack 各配置参数</span></span><br><span class="line">  <span class="keyword">let</span> compiler = <span class="keyword">new</span> Compiler(options.context)             <span class="comment">// 初始化 compiler 对象，这里 options.context 为 process.cwd()</span></span><br><span class="line">  compiler.options = options                               <span class="comment">// 往 compiler 添加初始化参数</span></span><br><span class="line">  <span class="keyword">new</span> NodeEnvironmentPlugin().apply(compiler)              <span class="comment">// 往 compiler 添加 Node 环境相关方法</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> options.plugins) &#123;</span><br><span class="line">    plugin.apply(compiler);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从例子中看到，我们的webpack配置了vue-loader-plugin，也就是源码里的vue-loader/lib/plugin.js，这是vue-loader强依赖的，如果不配置vue-loader-plugin，就会抛出错误。根据上面wbepack执行过程，在执行vue-loader核心代码之前，会先经过vue-loader-plugin。那么它到底做了哪些事情？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue-loader/lib/plugin.js</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueLoaderPlugin</span> </span>&#123;</span><br><span class="line">  apply (compiler) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件注册（简化了源代码）</span></span><br><span class="line">    compiler.hooks.compilation.tap(id, compilation =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> normalModuleLoader = compilation.hooks.normalModuleLoader</span><br><span class="line">      normalModuleLoader.tap(id, loaderContext =&gt; &#123;</span><br><span class="line">        loaderContext[NS] = <span class="literal">true</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> rawRules = compiler.options.module.rules</span><br><span class="line">    <span class="keyword">const</span> &#123; rules &#125; = <span class="keyword">new</span> RuleSet(rawRules)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 它的职责是将你定义过的其它规则复制并应用到 .vue 文件里相应语言的块。</span></span><br><span class="line">    <span class="comment">// 例如，如果你有一条匹配 /\.js$/ 的规则，那么它会应用到 .vue 文件里的 &lt;script&gt; 块。</span></span><br><span class="line">    <span class="keyword">const</span> clonedRules = rules</span><br><span class="line">      .filter(<span class="function"><span class="params">r</span> =&gt;</span> r !== vueRule)</span><br><span class="line">      .map(cloneRule)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// global pitcher (responsible for injecting template compiler loader &amp; CSS</span></span><br><span class="line">    <span class="comment">// post loader)</span></span><br><span class="line">    <span class="comment">// 这个pitcher-loader的作用之一就是给template块添加template-loader，给style块添加style-post-loader，并分别导出一个新的js module request</span></span><br><span class="line">    <span class="keyword">const</span> pitcher = &#123;</span><br><span class="line">      loader: <span class="built_in">require</span>.resolve(<span class="string">'./loaders/pitcher'</span>),</span><br><span class="line">      resourceQuery: <span class="function"><span class="params">query</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> parsed = qs.parse(query.slice(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> parsed.vue != <span class="literal">null</span></span><br><span class="line">      &#125;,</span><br><span class="line">      options: &#123;</span><br><span class="line">        cacheDirectory: vueLoaderUse.options.cacheDirectory,</span><br><span class="line">        cacheIdentifier: vueLoaderUse.options.cacheIdentifier</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// replace original rules</span></span><br><span class="line">    compiler.options.module.rules = [</span><br><span class="line">      pitcher,</span><br><span class="line">      ...clonedRules,</span><br><span class="line">      ...rules</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createMatcher</span> (<span class="params">fakeFile</span>) </span>&#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cloneRule</span> (<span class="params">rule</span>) </span>&#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line"></span><br><span class="line">VueLoaderPlugin.NS = NS</span><br><span class="line"><span class="built_in">module</span>.exports = VueLoaderPlugin</span><br></pre></td></tr></table></figure>
<p>从上面源码可以看出，vue-loader-plugin导出的是一个类，并且只包含了一个apply方法。这个apply方法就是被webpack调用的。</p>
<p>apply方法其实就做了3件事：</p>
<ol>
<li><p>事件监听：在normalModuleLoader钩子执行前调用代码：loaderContext[NS] = true<br>（每解析一个module，都会用到normalModuleLoader，由于每解析一个module都会有一个新的loaderContext，vue-loader/lib/index.js会判断loaderContext[NS]的值，为保证经过vue-loader执行时不报错，需要在这里标记loaderContext[NS] = true。）</p>
<blockquote>
<p>说明：loader中的this是一个叫做loaderContext的对象，这是webpack提供的，是loader的上下文对象，里面包含loader可以访问的方法或属性。</p>
</blockquote>
</li>
<li><p>将webpack中配置的rules利用webpack的new RuleSet进行格式化（<a href="https://webpack.js.org/configuration/module#modulerules" target="_blank" rel="noopener">rules配置</a>），并clone一份rules给.vue文件里的每个block使用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">rules = [&#123;</span><br><span class="line">  resource: f (),</span><br><span class="line">  use: [&#123;</span><br><span class="line">    loader: <span class="string">"vue-loader"</span>,</span><br><span class="line">    options: <span class="literal">undefined</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  resourceQuery: f (),</span><br><span class="line">  use: [&#123;</span><br><span class="line">    loader: <span class="string">"babel-loader"</span>,</span><br><span class="line">    options: <span class="literal">undefined</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  resourceQuery: f (),</span><br><span class="line">  use: [&#123;</span><br><span class="line">    loader: <span class="string">"babel-loader"</span>,</span><br><span class="line">    options: <span class="literal">undefined</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  resource: ƒ (),</span><br><span class="line">  oneOf: [&#123;</span><br><span class="line">    resourceQuery: ƒ (),</span><br><span class="line">    use: [&#123;</span><br><span class="line">      loader: <span class="string">"pug-plain-loader"</span>, <span class="attr">options</span>: <span class="literal">undefined</span></span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    use: [&#123;</span><br><span class="line">      loader: <span class="string">"raw-loader"</span>,</span><br><span class="line">      options: <span class="literal">undefined</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      loader: <span class="string">"pug-plain-loader"</span>,</span><br><span class="line">      options: <span class="literal">undefined</span></span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>在rules里加入vue-loader内部提供的rule（暂且称为pitcher-rule），其对应的loader是pitcher-loader，同时将原始的rules替换成pitcher-rule、cloneRules、rules。至于pitcher-rule、pitcher-loader做了什么，我们后面再讲。</p>
</li>
</ol>
<p>放一张图总结下vue-loader-plugin的整体流程：</p>
<p><img src="https://github.com/xixizhangfe/markdownImages/blob/master/vue-loader-plugin%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B.jpg?raw=true" width="300" height="400"></p>
<h1 id="vue-loader"><a href="#vue-loader" class="headerlink" title="vue-loader"></a>vue-loader</h1><p>当webpack加载入口文件main.js时，依赖到了source.vue，webpack内部会匹配source.vue的loaders，发现是vue-loader，然后就会去执行vue-loader(<a href="https://github.com/vuejs/vue-loader/blob/master/lib/index.js" target="_blank" rel="noopener">vue-loader/lib/index.js</a>)。接下来，我们分析vue-loader的实现过程。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue-loader/lib/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> loaderContext = <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 会先判断是否加载了vue-loader-plugin，没有则报错</span></span><br><span class="line">  <span class="keyword">if</span> (!errorEmitted &amp;&amp; !loaderContext[<span class="string">'thread-loader'</span>] &amp;&amp; !loaderContext[NS]) &#123;</span><br><span class="line">    <span class="comment">// 略</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从loaderContext获取信息</span></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    target, <span class="comment">// 编译的目标，是从webpack配置中传递过来的，默认是'web'，也可以是'node'等</span></span><br><span class="line">    request, <span class="comment">// 请求的资源的路径（每个资源都有一个路径）</span></span><br><span class="line">    minimize, <span class="comment">// 是否压缩：true/false，现在已废弃</span></span><br><span class="line">    sourceMap, <span class="comment">// 是否生成sourceMap: true/false</span></span><br><span class="line">    rootContext, <span class="comment">// 当前项目绝对路径，对本例子来说是：/Users/zhangxixi/knowledge collect/vue-loader</span></span><br><span class="line">    resourcePath, <span class="comment">// 资源文件的绝对路径，对本例子来说是：/Users/zhangxixi/knowledge collect/vue-loader/example/source.vue</span></span><br><span class="line">    resourceQuery <span class="comment">// 资源的 query 参数，也就是问号及后面的，如 ?vue&amp;type=custom&amp;index=0&amp;blockType=foo</span></span><br><span class="line">  &#125; = loaderContext</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开始解析SFC，其实就是根据不同的 block 来拆解对应的内容</span></span><br><span class="line">  <span class="comment">// parse函数返回的是compiler.parseComponent()的结果</span></span><br><span class="line">  <span class="comment">// 如果没有自定义compiler，compiler对应的就是vue-template-compiler。</span></span><br><span class="line">  <span class="keyword">const</span> descriptor = parse(&#123;</span><br><span class="line">    source,</span><br><span class="line">    compiler: options.compiler || loadTemplateCompiler(loaderContext), <span class="comment">// 如果loader的options没有配置compiler, 则使用vue-template-compiler</span></span><br><span class="line">    filename,</span><br><span class="line">    sourceRoot,</span><br><span class="line">    needMap: sourceMap</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果是语言块，则直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (incomingQuery.type) &#123;</span><br><span class="line">    <span class="keyword">return</span> selectBlock(</span><br><span class="line">      descriptor,</span><br><span class="line">      loaderContext,</span><br><span class="line">      incomingQuery,</span><br><span class="line">      !!options.appendExtension</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 接下来分别对不同block的请求进行处理</span></span><br><span class="line">  <span class="comment">// template</span></span><br><span class="line">  <span class="comment">// 处理template，根据descriptor.template，生成template的js module（生成import语句）</span></span><br><span class="line">  <span class="comment">/* 生成的template请求</span></span><br><span class="line"><span class="comment">    import &#123; render, staticRenderFns &#125; from "./source.vue?vue&amp;type=template&amp;id=27e4e96e&amp;scoped=true&amp;lang=pug&amp;"</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">let</span> templateImport = <span class="string">`var render, staticRenderFns`</span></span><br><span class="line">  <span class="keyword">let</span> templateRequest</span><br><span class="line">  <span class="keyword">if</span> (descriptor.template) &#123;</span><br><span class="line">    <span class="keyword">const</span> src = descriptor.template.src || resourcePath</span><br><span class="line">    <span class="keyword">const</span> idQuery = <span class="string">`&amp;id=<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line">    <span class="keyword">const</span> scopedQuery = hasScoped ? <span class="string">`&amp;scoped=true`</span> : <span class="string">``</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把attrs转成query格式：&#123;lang: pug&#125; =&gt; &amp;lang=pug</span></span><br><span class="line">    <span class="keyword">const</span> attrsQuery = attrsToQuery(descriptor.template.attrs)</span><br><span class="line">    <span class="comment">// 如果css有scope，那么template就需要加上scoped=true，这是why？？</span></span><br><span class="line">    <span class="keyword">const</span> query = <span class="string">`?vue&amp;type=template<span class="subst">$&#123;idQuery&#125;</span><span class="subst">$&#123;scopedQuery&#125;</span><span class="subst">$&#123;attrsQuery&#125;</span><span class="subst">$&#123;inheritQuery&#125;</span>`</span></span><br><span class="line">    <span class="keyword">const</span> request = templateRequest = stringifyRequest(src + query)</span><br><span class="line">    <span class="comment">// 这个request会经过pug-plain-loader、template-loader</span></span><br><span class="line">    <span class="comment">// 最终template-loader会返回render, staticRenderFns这两个函数</span></span><br><span class="line">    templateImport = <span class="string">`import &#123; render, staticRenderFns &#125; from <span class="subst">$&#123;request&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// script</span></span><br><span class="line">  <span class="comment">// 处理script，与template类似</span></span><br><span class="line">  <span class="comment">/* 生成的script请求：</span></span><br><span class="line"><span class="comment">    import script from "./source.vue?vue&amp;type=script&amp;lang=js&amp;"</span></span><br><span class="line"><span class="comment">    export * from "./source.vue?vue&amp;type=script&amp;lang=js&amp;"</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">let</span> scriptImport = <span class="string">`var script = &#123;&#125;`</span></span><br><span class="line">  <span class="keyword">if</span> (descriptor.script) &#123;</span><br><span class="line">    <span class="keyword">const</span> src = descriptor.script.src || resourcePath</span><br><span class="line">    <span class="keyword">const</span> attrsQuery = attrsToQuery(descriptor.script.attrs, <span class="string">'js'</span>)</span><br><span class="line">    <span class="keyword">const</span> query = <span class="string">`?vue&amp;type=script<span class="subst">$&#123;attrsQuery&#125;</span><span class="subst">$&#123;inheritQuery&#125;</span>`</span></span><br><span class="line">    <span class="keyword">const</span> request = stringifyRequest(src + query)</span><br><span class="line">    <span class="comment">/* script不会再经过其他loader处理，所以从request里import的script就是对应的源码，如</span></span><br><span class="line"><span class="comment">      &#123;</span></span><br><span class="line"><span class="comment">        data () &#123;</span></span><br><span class="line"><span class="comment">          return &#123;</span></span><br><span class="line"><span class="comment">            msg: 'fesfff'</span></span><br><span class="line"><span class="comment">          &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">      &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    scriptImport = (</span><br><span class="line">      <span class="string">`import script from <span class="subst">$&#123;request&#125;</span>\n`</span> +</span><br><span class="line">      <span class="string">`export * from <span class="subst">$&#123;request&#125;</span>`</span> <span class="comment">// support named exports</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// styles</span></span><br><span class="line">  <span class="comment">// 处理styles</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    genStylesCode做了3件事情:</span></span><br><span class="line"><span class="comment">    1. 生成import语句（这一步与template生成import语句类似）</span></span><br><span class="line"><span class="comment">    2. 如果需要热加载，添加热加载代码</span></span><br><span class="line"><span class="comment">    3.如果需要注入样式，则添加样式注入函数injectStyles</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="comment">/* 生成的style请求：</span></span><br><span class="line"><span class="comment">    import style0 from "./source.vue?vue&amp;type=style&amp;index=0&amp;id=27e4e96e&amp;scoped=true&amp;lang=css&amp;"</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">let</span> stylesCode = <span class="string">``</span></span><br><span class="line">  <span class="keyword">if</span> (descriptor.styles.length) &#123;</span><br><span class="line">    stylesCode = genStylesCode(</span><br><span class="line">      loaderContext,</span><br><span class="line">      descriptor.styles, <span class="comment">// vue单文件组件支持多个style标签，故descriptor.styles是数组</span></span><br><span class="line">      id,</span><br><span class="line">      resourcePath,</span><br><span class="line">      stringifyRequest,</span><br><span class="line">      needsHotReload,</span><br><span class="line">      isServer || isShadow <span class="comment">// needs explicit injection?</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将由 .vue 提供 render函数/staticRenderFns，js script，style样式，并交由 normalizer 进行统一的格式化，最终导出 component.exports</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果stylesCode里含有injectStyles，则表明是需要注入style的，因此可以使用这个正则来判断：/injectStyles/.test(stylesCode)</span></span><br><span class="line">  <span class="keyword">let</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">  <span class="subst">$&#123;templateImport&#125;</span></span></span><br><span class="line"><span class="string">  <span class="subst">$&#123;scriptImport&#125;</span></span></span><br><span class="line"><span class="string">  <span class="subst">$&#123;stylesCode&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  /* normalize component */</span></span><br><span class="line"><span class="string">  import normalizer from <span class="subst">$&#123;stringifyRequest(<span class="string">`!<span class="subst">$&#123;componentNormalizerPath&#125;</span>`</span>)&#125;</span></span></span><br><span class="line"><span class="string">  var component = normalizer(</span></span><br><span class="line"><span class="string">    script,</span></span><br><span class="line"><span class="string">    render,</span></span><br><span class="line"><span class="string">    staticRenderFns,</span></span><br><span class="line"><span class="string">    <span class="subst">$&#123;hasFunctional ? <span class="string">`true`</span> : <span class="string">`false`</span>&#125;</span>,</span></span><br><span class="line"><span class="string">    <span class="subst">$&#123;<span class="regexp">/injectStyles/</span>.test(stylesCode) ? <span class="string">`injectStyles`</span> : <span class="string">`null`</span>&#125;</span>,</span></span><br><span class="line"><span class="string">    <span class="subst">$&#123;hasScoped ? <span class="built_in">JSON</span>.stringify(id) : <span class="string">`null`</span>&#125;</span>,</span></span><br><span class="line"><span class="string">    <span class="subst">$&#123;isServer ? <span class="built_in">JSON</span>.stringify(hash(request)) : <span class="string">`null`</span>&#125;</span></span></span><br><span class="line"><span class="string">    <span class="subst">$&#123;isShadow ? <span class="string">`,true`</span> : <span class="string">``</span>&#125;</span></span></span><br><span class="line"><span class="string">  )</span></span><br><span class="line"><span class="string">    `</span>.trim() + <span class="string">`\n`</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (descriptor.customBlocks &amp;&amp; descriptor.customBlocks.length) &#123;</span><br><span class="line">      code += genCustomBlocksCode(</span><br><span class="line">        descriptor.customBlocks,</span><br><span class="line">        resourcePath,</span><br><span class="line">        resourceQuery,</span><br><span class="line">        stringifyRequest</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needsHotReload) &#123;</span><br><span class="line">      code += <span class="string">`\n`</span> + genHotReloadCode(id, hasFunctional, templateRequest)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Expose filename. This is used by the devtools and Vue runtime warnings.</span></span><br><span class="line">    <span class="keyword">if</span> (!isProduction) &#123;</span><br><span class="line">      <span class="comment">// Expose the file's full path in development, so that it can be opened</span></span><br><span class="line">      <span class="comment">// from the devtools.</span></span><br><span class="line">      code += <span class="string">`\ncomponent.options.__file = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(rawShortFilePath.replace(<span class="regexp">/\\/g</span>, <span class="string">'/'</span>))&#125;</span>`</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.exposeFilename) &#123;</span><br><span class="line">      <span class="comment">// Libraies can opt-in to expose their components' filenames in production builds.</span></span><br><span class="line">      <span class="comment">// For security reasons, only expose the file's basename in production.</span></span><br><span class="line">      code += <span class="string">`\ncomponent.options.__file = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(filename)&#125;</span>`</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    code += <span class="string">`\nexport default component.exports`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// console.log(code)</span></span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">module</span>.exports.VueLoaderPlugin = plugin</span><br></pre></td></tr></table></figure>
<p>vue-loader整体流程图：</p>
<p><img src="https://github.com/xixizhangfe/markdownImages/blob/master/vue-loader%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B.jpg?raw=true"></p>
<p>可以看出，整个过程大体可以分为3个阶段。</p>
<h2 id="第一阶段"><a href="#第一阶段" class="headerlink" title="第一阶段"></a>第一阶段</h2><p>这一阶段是将.vue文件解析成js代码。</p>
<ol>
<li><p>会先判断是否加载了vue-loader-plugin，没有则报错</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!errorEmitted &amp;&amp; !loaderContext[<span class="string">'thread-loader'</span>] &amp;&amp; !loaderContext[NS]) &#123;</span><br><span class="line">  <span class="comment">// 略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>从loaderContext中获取到模块的信息，比如request、resourcePath、resourceQuery等</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  target, <span class="comment">// 编译的目标，是从webpack配置中传递过来的，默认是'web'，也可以是'node'等</span></span><br><span class="line">  request, <span class="comment">// 请求的资源的路径（每个资源都有一个路径）</span></span><br><span class="line">  minimize, <span class="comment">// 是否压缩：true/false，现在已废弃</span></span><br><span class="line">  sourceMap, <span class="comment">// 是否生成sourceMap: true/false</span></span><br><span class="line">  rootContext, <span class="comment">// 当前项目绝对路径，对本例子来说是：/Users/zhangxixi/knowledge collect/vue-loader</span></span><br><span class="line">  resourcePath, <span class="comment">// 资源文件的绝对路径，对本例子来说是：/Users/zhangxixi/knowledge collect/vue-loader/example/source.vue</span></span><br><span class="line">  resourceQuery <span class="comment">// 资源的 query 参数，也就是问号及后面的，如 ?vue&amp;type=custom&amp;index=0&amp;blockType=foo</span></span><br><span class="line">&#125; = loaderContext</span><br></pre></td></tr></table></figure>
</li>
<li><p>对.vue文件进行parse，其实就是把.vue分成template、script、style、customBlocks这几部分</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> descriptor = parse(&#123;</span><br><span class="line">  source,</span><br><span class="line">  compiler: options.compiler || loadTemplateCompiler(loaderContext), <span class="comment">// 如果loader的options没有配置compiler, 则使用vue-template-compiler</span></span><br><span class="line">  filename,</span><br><span class="line">  sourceRoot,</span><br><span class="line">  needMap: sourceMap</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p> 这一阶段最关键的就是parse过程，parse前后对比如下：</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parse之前 source是：</span></span><br><span class="line"><span class="string">'&lt;template lang="pug"&gt;\ndiv(ok)\n  h1(:class="$style.red") hello\n&lt;/template&gt;\n\n&lt;script&gt;\nexport default &#123;\n  data () &#123;\n    return &#123;\n      msg: \'fesfff\'\n    &#125;\n  &#125;\n&#125;\n&lt;/script&gt;\n\n&lt;style scoped&gt;\n.red &#123;\n  color: red;\n&#125;\n&lt;/style&gt;\n\n&lt;foo&gt;\nexport default comp =&gt; &#123;\n  console.log(comp.options.data())\n&#125;\n&lt;/foo&gt;\n'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// parse之后 得到的结果</span></span><br><span class="line">&#123;</span><br><span class="line">  template:</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">'template'</span>,</span><br><span class="line">      content: <span class="string">'\ndiv(ok)\n  h1(:class="$style.red") hello\n'</span>,</span><br><span class="line">      start: <span class="number">21</span>,</span><br><span class="line">      attrs: &#123; <span class="attr">lang</span>: <span class="string">'pug'</span> &#125;,</span><br><span class="line">      lang: <span class="string">'pug'</span>,</span><br><span class="line">      end: <span class="number">62</span></span><br><span class="line">    &#125;,</span><br><span class="line">  script:</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">'script'</span>,</span><br><span class="line">      content:</span><br><span class="line">      <span class="string">'//\n//\n//\n//\n//\n\nexport default &#123;\n  data () &#123;\n    return &#123;\n      msg: \'fesfff\'\n    &#125;\n  &#125;\n&#125;\n'</span>,</span><br><span class="line">      start: <span class="number">83</span>,</span><br><span class="line">      attrs: &#123;&#125;,</span><br><span class="line">      end: <span class="number">158</span>,</span><br><span class="line">      map:</span><br><span class="line">      &#123; <span class="attr">version</span>: <span class="number">3</span>,</span><br><span class="line">        sources: [<span class="built_in">Array</span>],</span><br><span class="line">        names: [],</span><br><span class="line">        mappings: <span class="string">';;;;;;AAMA;AACA;AACA;AACA;AACA;AACA;AACA'</span>,</span><br><span class="line">        file: <span class="string">'source.vue'</span>,</span><br><span class="line">        sourceRoot: <span class="string">'example'</span>,</span><br><span class="line">        sourcesContent: [<span class="built_in">Array</span>] &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  styles:</span><br><span class="line">    [ &#123; <span class="attr">type</span>: <span class="string">'style'</span>,</span><br><span class="line">        content: <span class="string">'\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n.red &#123;\n  color: red;\n&#125;\n'</span>,</span><br><span class="line">        start: <span class="number">183</span>,</span><br><span class="line">        attrs: [<span class="built_in">Object</span>],</span><br><span class="line">        scoped: <span class="literal">true</span>,</span><br><span class="line">        end: <span class="number">207</span>,</span><br><span class="line">        map: [<span class="built_in">Object</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">  customBlocks:</span><br><span class="line">    [ &#123; <span class="attr">type</span>: <span class="string">'foo'</span>,</span><br><span class="line">        content:</span><br><span class="line">        <span class="string">'\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nexport default comp =&gt; &#123;\n  console.log(comp.options.data())\n&#125;\n'</span>,</span><br><span class="line">        start: <span class="number">222</span>,</span><br><span class="line">        attrs: &#123;&#125;,</span><br><span class="line">        end: <span class="number">285</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">  errors: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后区分.vue请求与block请求（请求source.vue就是.vue请求，source.vue里依赖了template、script等block，那么这些依赖会被解析成.source.vue?vue&amp;type=template这种带query的，我们称之为block请求）。如果是.vue请求，则需要生成js module。否则就执行selectBlock。第一阶段是.vue请求，因此会生成js module：分别生成template、script、style、customBlock的请求路径（这里会在query上添加’vue’，比如./source.vue?vue&amp;type=script&amp;lang=js，这会在第二阶段用到）；添加热加载逻辑。</p>
</li>
</ol>
<p>vue-loader第一阶段生成的js代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; render, staticRenderFns &#125; <span class="keyword">from</span> <span class="string">"./source.vue?vue&amp;type=template&amp;id=27e4e96e&amp;scoped=true&amp;lang=pug&amp;"</span></span><br><span class="line"><span class="keyword">import</span> script <span class="keyword">from</span> <span class="string">"./source.vue?vue&amp;type=script&amp;lang=js&amp;"</span></span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">"./source.vue?vue&amp;type=script&amp;lang=js&amp;"</span></span><br><span class="line"><span class="keyword">import</span> style0 <span class="keyword">from</span> <span class="string">"./source.vue?vue&amp;type=style&amp;index=0&amp;id=27e4e96e&amp;scoped=true&amp;lang=css&amp;"</span></span><br><span class="line"><span class="keyword">import</span> normalizer <span class="keyword">from</span> <span class="string">"!../lib/runtime/componentNormalizer.js"</span></span><br><span class="line"><span class="keyword">var</span> component = normalizer(</span><br><span class="line">  script,</span><br><span class="line">  render,</span><br><span class="line">  staticRenderFns,</span><br><span class="line">  <span class="literal">false</span>,</span><br><span class="line">  <span class="literal">null</span>,</span><br><span class="line">  <span class="string">"27e4e96e"</span>,</span><br><span class="line">  <span class="literal">null</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">import</span> block0 <span class="keyword">from</span> <span class="string">"./source.vue?vue&amp;type=custom&amp;index=0&amp;blockType=foo"</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> block0 === <span class="string">'function'</span>) block0(component)</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">module</span>.hot) &#123;</span><br><span class="line">  <span class="keyword">var</span> api = <span class="built_in">require</span>(<span class="string">"/Users/zhangxixi/knowledge collect/vue-loader/node_modules/_vue-hot-reload-api@2.3.3@vue-hot-reload-api/dist/index.js"</span>)</span><br><span class="line">  api.install(<span class="built_in">require</span>(<span class="string">'vue'</span>))</span><br><span class="line">  <span class="keyword">if</span> (api.compatible) &#123;</span><br><span class="line">    <span class="built_in">module</span>.hot.accept()</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">module</span>.hot.data) &#123;</span><br><span class="line">      api.createRecord(<span class="string">'27e4e96e'</span>, component.options)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      api.reload(<span class="string">'27e4e96e'</span>, component.options)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">module</span>.hot.accept(<span class="string">"./source.vue?vue&amp;type=template&amp;id=27e4e96e&amp;scoped=true&amp;lang=pug&amp;"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      api.rerender(<span class="string">'27e4e96e'</span>, &#123;</span><br><span class="line">        render: render,</span><br><span class="line">        staticRenderFns: staticRenderFns</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">component.options.__file = <span class="string">"example/source.vue"</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> component.exports</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/xixizhangfe/markdownImages/blob/master/vue-loader%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5.jpg?raw=true" alt="vue-loader第一阶段"></p>
<h2 id="第二阶段"><a href="#第二阶段" class="headerlink" title="第二阶段"></a>第二阶段</h2><p>第一阶段返回的js代码交与webpack继续解析，代码里的这几个import请求就会被接着进行依赖解析，这样就会接着请求所依赖的template、script、style、customBlock。</p>
<p>我们以template的请求为例：<br><code>import { render, staticRenderFns } from &quot;./source.vue?vue&amp;type=template&amp;id=27e4e96e&amp;scoped=true&amp;lang=pug&amp;&quot;</code>，webpack解析出这个module需要的loaders是：pitcher-loader、pug-plain-loader、vue-loader。需要哪些loader是webpack内部根据rules来匹配的，这里的rules是经过vue-loader-plugin处理后的。之所以能解析出pitcher-loader，是因为query里含有vue，此时，是时候回过头来看一下vue-loader-plugin中pitcher-rule和pitcher-loader的代码了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue-loader/lib/plugin.js</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// global pitcher (responsible for injecting template compiler loader &amp; CSS</span></span><br><span class="line">    <span class="comment">// post loader)</span></span><br><span class="line">    <span class="keyword">const</span> pitcher = &#123;</span><br><span class="line">      loader: <span class="built_in">require</span>.resolve(<span class="string">'./loaders/pitcher'</span>),</span><br><span class="line">      resourceQuery: <span class="function"><span class="params">query</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> parsed = qs.parse(query.slice(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> parsed.vue != <span class="literal">null</span></span><br><span class="line">      &#125;,</span><br><span class="line">      options: &#123;</span><br><span class="line">        cacheDirectory: vueLoaderUse.options.cacheDirectory,</span><br><span class="line">        cacheIdentifier: vueLoaderUse.options.cacheIdentifier</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>从上面代码可以看到，pitcher-rule是通过resourceQuery中是否有vue进行匹配的。从第一阶段返回的代码中可以看到，template、script、style、custom-block的请求query中都带有vue。所以这个rule就是匹配这几个block请求的。如果匹配到了，那么pitcher-loader就会加入到这些请求需要的loader数组中。pitcher-loader来自于vue-loader/lib/loaders/pitcher.js。那我们来看一下这个pitcher-loader到底做了什么：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue-loader/lib/loaders/pitcher.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">code</span> =&gt;</span> code</span><br><span class="line"><span class="built_in">module</span>.exports.pitch = <span class="function"><span class="keyword">function</span> (<span class="params">remainingRequest</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">const</span> query = qs.parse(<span class="keyword">this</span>.resourceQuery.slice(<span class="number">1</span>))</span><br><span class="line">  <span class="keyword">let</span> loaders = <span class="keyword">this</span>.loaders</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if this is a language block request, eslint-loader may get matched</span></span><br><span class="line">  <span class="comment">// multiple times</span></span><br><span class="line">  <span class="keyword">if</span> (query.type) &#123;</span><br><span class="line">    <span class="comment">// if this is an inline block, since the whole file itself is being linted,</span></span><br><span class="line">    <span class="comment">// remove eslint-loader to avoid duplicate linting.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/\.vue$/</span>.test(<span class="keyword">this</span>.resourcePath)) &#123;</span><br><span class="line">      loaders = loaders.filter(<span class="function"><span class="params">l</span> =&gt;</span> !isESLintLoader(l))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This is a src import. Just make sure there's not more than 1 instance</span></span><br><span class="line">      <span class="comment">// of eslint present.</span></span><br><span class="line">      loaders = dedupeESLintLoader(loaders)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// remove self</span></span><br><span class="line">  loaders = loaders.filter(isPitcher)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Inject style-post-loader before css-loader for scoped CSS and trimming</span></span><br><span class="line">  <span class="keyword">if</span> (query.type === <span class="string">`style`</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cssLoaderIndex = loaders.findIndex(isCSSLoader)</span><br><span class="line">    <span class="keyword">if</span> (cssLoaderIndex &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> afterLoaders = loaders.slice(<span class="number">0</span>, cssLoaderIndex + <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">const</span> beforeLoaders = loaders.slice(cssLoaderIndex + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> request = genRequest([</span><br><span class="line">        ...afterLoaders,</span><br><span class="line">        stylePostLoaderPath,</span><br><span class="line">        ...beforeLoaders</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">`import mod from <span class="subst">$&#123;request&#125;</span>; export default mod; export * from <span class="subst">$&#123;request&#125;</span>`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// for templates: inject the template compiler &amp; optional cache</span></span><br><span class="line">  <span class="keyword">if</span> (query.type === <span class="string">`template`</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line">    <span class="keyword">const</span> cacheLoader = cacheDirectory &amp;&amp; cacheIdentifier</span><br><span class="line">      ? [<span class="string">`cache-loader?<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        <span class="regexp">//</span> For some reason, webpack fails to generate consistent hash <span class="keyword">if</span> we</span></span></span><br><span class="line"><span class="string"><span class="subst">        <span class="regexp">//</span> use absolute paths here, even though the path is only used <span class="keyword">in</span> a</span></span></span><br><span class="line"><span class="string"><span class="subst">        <span class="regexp">//</span> comment. For now we have to ensure cacheDirectory is a relative path.</span></span></span><br><span class="line"><span class="string"><span class="subst">        cacheDirectory: (path.isAbsolute(cacheDirectory)</span></span></span><br><span class="line"><span class="string"><span class="subst">          ? path.relative(process.cwd(), cacheDirectory)</span></span></span><br><span class="line"><span class="string"><span class="subst">          : cacheDirectory).replace(<span class="regexp">/\\/g</span>, <span class="string">'/'</span>),</span></span></span><br><span class="line"><span class="string"><span class="subst">        cacheIdentifier: hash(cacheIdentifier) + <span class="string">'-vue-loader-template'</span></span></span></span><br><span class="line"><span class="string"><span class="subst">      &#125;</span>)&#125;`</span>]</span><br><span class="line">      : []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> preLoaders = loaders.filter(isPreLoader)</span><br><span class="line">    <span class="keyword">const</span> postLoaders = loaders.filter(isPostLoader)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> request = genRequest([</span><br><span class="line">      ...cacheLoader,</span><br><span class="line">      ...postLoaders,</span><br><span class="line">      templateLoaderPath + <span class="string">`??vue-loader-options`</span>,</span><br><span class="line">      ...preLoaders</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the template compiler uses esm exports</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">`export * from <span class="subst">$&#123;request&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if a custom block has no other matching loader other than vue-loader itself</span></span><br><span class="line">  <span class="comment">// or cache-loader, we should ignore it</span></span><br><span class="line">  <span class="keyword">if</span> (query.type === <span class="string">`custom`</span> &amp;&amp; shouldIgnoreCustomBlock(loaders)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">``</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// When the user defines a rule that has only resourceQuery but no test,</span></span><br><span class="line">  <span class="comment">// both that rule and the cloned rule will match, resulting in duplicated</span></span><br><span class="line">  <span class="comment">// loaders. Therefore it is necessary to perform a dedupe here.</span></span><br><span class="line">  <span class="keyword">const</span> request = genRequest(loaders)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`import mod from <span class="subst">$&#123;request&#125;</span>; export default mod; export * from <span class="subst">$&#123;request&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pitcher-loader做了三件事情，最关键的是第三件事情：</p>
<ol>
<li>剔除eslint-loader</li>
<li>剔除pitcher-loader自身</li>
<li>根据不同的query进行拦截处理，返回对应的内容，跳过后面的loader执行部分</li>
</ol>
<p>对于style的处理，先判断是否有css-loader，有的话就生成一个新的request，这个过程会将vue-loader内部的style-post-loader添加进去，然后返回一个js请求。根据pitch的规则，pitcher-loader后面的loader都会被跳过，然后就开始解析这个返回的js请求，它的的内容是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mod <span class="keyword">from</span> <span class="string">"-!../node_modules/_vue-style-loader@4.1.2@vue-style-loader/index.js!../node_modules/_css-loader@1.0.1@css-loader/index.js!../lib/loaders/stylePostLoader.js!../lib/index.js??vue-loader-options!./source.vue?vue&amp;type=style&amp;index=0&amp;id=27e4e96e&amp;scoped=true&amp;lang=css&amp;"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> mod; <span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">"-!../node_modules/_vue-style-loader@4.1.2@vue-style-loader/index.js!../node_modules/_css-loader@1.0.1@css-loader/index.js!../lib/loaders/stylePostLoader.js!../lib/index.js??vue-loader-options!./source.vue?vue&amp;type=style&amp;index=0&amp;id=27e4e96e&amp;scoped=true&amp;lang=css&amp;"</span></span><br></pre></td></tr></table></figure>
<p>对于template的处理类似，也会生成一个新的request，这个过程会将vue-loader内部提供的template-loader加进去，并返回一个js请求：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">"-!../lib/loaders/templateLoader.js??vue-loader-options!../node_modules/_pug-plain-loader@1.0.0@pug-plain-loader/index.js!../lib/index.js??vue-loader-options!./source.vue?vue&amp;type=template&amp;id=27e4e96e&amp;scoped=true&amp;lang=pug&amp;"</span></span><br></pre></td></tr></table></figure>
<p>其他block也是类似的。</p>
<p><img src="https://github.com/xixizhangfe/markdownImages/blob/master/vue-loader%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5.jpg?raw=true" alt="vue-loader第二阶段"></p>
<h2 id="第三阶段"><a href="#第三阶段" class="headerlink" title="第三阶段"></a>第三阶段</h2><p>经过第二阶段后，webpack会继续解析每个block对应的js请求。根据这些请求，webpack会匹配到相应的loaders。</p>
<p>对于style，对应的loader是vue-style-loader、css-loader、style-post-loader、vue-loader。执行顺序就是：</p>
<p>vue-style-loader的pitch、css-loader的pitch、style-post-loader的pitch、vue-loader的pitch、vue-loader（分离出style block）、style-post-loader（处理scoped css）、css-loader（处理相关资源的引入路径）、vue-style-loader（动态创建style标签插入css）。</p>
<p>对于template，对应的loader是template-loader、pug-plain-loader、vue-loader，执行顺序是：</p>
<p>template-loader的pitch、pug-plain-loader的pitch、vue-loader的pitch、vue-loader（分离出template block）、pug-plain-loader（将pug模板转化为html字符串）、template-loader（编译 html 模板字符串，生成 render/staticRenderFns 函数并暴露出去）。</p>
<p>其他模块类似。</p>
<p>会发现，在不考虑pitch函数的时候，第三阶段里最先执行的都是vue-loader，此时query是有值的，所以会进入到selecBlock阶段。（这就是vue-loader执行时与第一阶段不同的地方）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue-loader/lib/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 如果是语言块，则直接返回</span></span><br><span class="line"><span class="keyword">if</span> (incomingQuery.type) &#123;</span><br><span class="line">  <span class="keyword">return</span> selectBlock(</span><br><span class="line">    descriptor,</span><br><span class="line">    loaderContext,</span><br><span class="line">    incomingQuery,</span><br><span class="line">    !!options.appendExtension</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>selectBlock来自select.js，那么我们来看看select.js做了什么：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">selectBlock</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  descriptor,</span></span></span><br><span class="line"><span class="function"><span class="params">  loaderContext,</span></span></span><br><span class="line"><span class="function"><span class="params">  query,</span></span></span><br><span class="line"><span class="function"><span class="params">  appendExtension</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// template</span></span><br><span class="line">  <span class="keyword">if</span> (query.type === <span class="string">`template`</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (appendExtension) &#123;</span><br><span class="line">      loaderContext.resourcePath += <span class="string">'.'</span> + (descriptor.template.lang || <span class="string">'html'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    loaderContext.callback(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      descriptor.template.content,</span><br><span class="line">      descriptor.template.map</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// script</span></span><br><span class="line">  <span class="keyword">if</span> (query.type === <span class="string">`script`</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (appendExtension) &#123;</span><br><span class="line">      loaderContext.resourcePath += <span class="string">'.'</span> + (descriptor.script.lang || <span class="string">'js'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    loaderContext.callback(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      descriptor.script.content,</span><br><span class="line">      descriptor.script.map</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// styles</span></span><br><span class="line">  <span class="keyword">if</span> (query.type === <span class="string">`style`</span> &amp;&amp; query.index != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> style = descriptor.styles[query.index]</span><br><span class="line">    <span class="keyword">if</span> (appendExtension) &#123;</span><br><span class="line">      loaderContext.resourcePath += <span class="string">'.'</span> + (style.lang || <span class="string">'css'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    loaderContext.callback(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      style.content,</span><br><span class="line">      style.map</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// custom</span></span><br><span class="line">  <span class="keyword">if</span> (query.type === <span class="string">'custom'</span> &amp;&amp; query.index != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> block = descriptor.customBlocks[query.index]</span><br><span class="line">    loaderContext.callback(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      block.content,</span><br><span class="line">      block.map</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>select.js其实就是根据不同的query类型，将相应的content和map传递给下一个loader。</p>
<p>最终生成的代码长什么样？</p>
<p>template最终解析代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> render = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _vm = <span class="keyword">this</span></span><br><span class="line">  <span class="keyword">var</span> _h = _vm.$createElement</span><br><span class="line">  <span class="keyword">var</span> _c = _vm._self._c || _h</span><br><span class="line">  <span class="keyword">return</span> _c(</span><br><span class="line">    <span class="string">"div"</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      attrs: &#123;</span><br><span class="line">        ok: <span class="string">""</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    [</span><br><span class="line">      _c(</span><br><span class="line">        <span class="string">"h1"</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          class: _vm.$style.red</span><br><span class="line">        &#125;,</span><br><span class="line">      [_vm._v(<span class="string">"hello"</span>)</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> staticRenderFns = []</span><br><span class="line"></span><br><span class="line">render._withStripped = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; render, staticRenderFns &#125;</span><br></pre></td></tr></table></figure>
<p>style最终解析代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.red[data-v<span class="number">-27e4</span>e96e] &#123;</span><br><span class="line">  color: red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/xixizhangfe/markdownImages/blob/master/vue-loader%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5.jpg?raw=true" alt="vue-loader第三阶段"></p>
<h1 id="一些有意思的代码实现"><a href="#一些有意思的代码实现" class="headerlink" title="一些有意思的代码实现"></a>一些有意思的代码实现</h1><h2 id="vue-plugin-loader是如何将rules里配置的规则应用到block里的？"><a href="#vue-plugin-loader是如何将rules里配置的规则应用到block里的？" class="headerlink" title="vue-plugin-loader是如何将rules里配置的规则应用到block里的？"></a>vue-plugin-loader是如何将rules里配置的规则应用到block里的？</h2><p>vue-loader-plugin的cloneRules源码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue-loader/lib/plugin.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cloneRule</span> (<span class="params">rule</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; resource, resourceQuery &#125; = rule</span><br><span class="line">  <span class="comment">// Assuming `test` and `resourceQuery` tests are executed in series and</span></span><br><span class="line">  <span class="comment">// synchronously (which is true based on RuleSet's implementation), we can</span></span><br><span class="line">  <span class="comment">// save the current resource being matched from `test` so that we can access</span></span><br><span class="line">  <span class="comment">// it in `resourceQuery`. This ensures when we use the normalized rule's</span></span><br><span class="line">  <span class="comment">// resource check, include/exclude are matched correctly.</span></span><br><span class="line">  <span class="keyword">let</span> currentResource</span><br><span class="line">  <span class="keyword">const</span> res = <span class="built_in">Object</span>.assign(&#123;&#125;, rule, &#123;</span><br><span class="line">    resource: &#123;</span><br><span class="line">      test: <span class="function"><span class="params">resource</span> =&gt;</span> &#123;</span><br><span class="line">        currentResource = resource</span><br><span class="line">        <span class="comment">// 始终返回true，是为了能让ruleSet在执行时能够进入resourceQuery的判断规则</span></span><br><span class="line">        <span class="comment">// 同时提供currentResource给resourceQuery使用</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    resourceQuery: <span class="function"><span class="params">query</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> parsed = qs.parse(query.slice(<span class="number">1</span>))</span><br><span class="line">      <span class="comment">// 如果query里没有vue，则说明不是.vue的block，不进行匹配</span></span><br><span class="line">      <span class="keyword">if</span> (parsed.vue == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// .vue里给block匹配loader时需要通过lang来匹配。如果没有指定lang，也不进行匹配。</span></span><br><span class="line">      <span class="comment">// 会发现，在为block生成request时，都会用到attrsToQuery，而style和script会给attrsToQuery分别传递'css', 'js'作为langFallback, customBlock和template则不需要传递</span></span><br><span class="line">      <span class="comment">// 这是因为我们写代码时style和script可以不写lang，不写默认是css、js。这时候vue-loader需要把默认的加上。</span></span><br><span class="line">      <span class="comment">// 而customBlock和template没有默认的lang，所以vue-loader不用提供默认的lang。</span></span><br><span class="line">      <span class="keyword">if</span> (resource &amp;&amp; parsed.lang == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 这里需要在原资源路径后拼接一个假的后缀，如source.vue.css，这是为了执行resource时，能够通过资源名后缀匹配到loader</span></span><br><span class="line">      <span class="comment">/* 比如，我们配置了一个规则是:</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">          test: /\.css$/,</span></span><br><span class="line"><span class="comment">          use: [</span></span><br><span class="line"><span class="comment">            'vue-style-loader',</span></span><br><span class="line"><span class="comment">            'css-loader'</span></span><br><span class="line"><span class="comment">          ]</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        经过new RuleSet后，会变成:</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">          resource: (resource) =&gt; &#123;</span></span><br><span class="line"><span class="comment">            return /\.css$/.test(resource)</span></span><br><span class="line"><span class="comment">          &#125;,</span></span><br><span class="line"><span class="comment">          use: [</span></span><br><span class="line"><span class="comment">            'vue-style-loader',</span></span><br><span class="line"><span class="comment">            'css-loader'</span></span><br><span class="line"><span class="comment">          ]</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        resource是一个函数，此时利用拼接的fakeResourcePath，resource(fakeResourcePath)就可以匹配成功了</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">const</span> fakeResourcePath = <span class="string">`<span class="subst">$&#123;currentResource&#125;</span>.<span class="subst">$&#123;parsed.lang&#125;</span>`</span></span><br><span class="line">      <span class="keyword">if</span> (resource &amp;&amp; !resource(fakeResourcePath)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (resourceQuery &amp;&amp; !resourceQuery(query)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rule.oneOf) &#123;</span><br><span class="line">    res.oneOf = rule.oneOf.map(cloneRule)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// replace original rules</span></span><br><span class="line">compiler.options.module.rules = [</span><br><span class="line">  pitcher,</span><br><span class="line">  ...clonedRules,</span><br><span class="line">  ...rules</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<h1 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h1><p>本文只是梳理了vue-loader的整体流程，具体源码细节请参考我写的<a href="https://github.com/xixizhangfe/vue-loader" target="_blank" rel="noopener">源码注释</a></p>
<h1 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h1><p><a href="https://github.com/CommanderXL/Biu-blog/issues/30" target="_blank" rel="noopener">webpack RuleSet源码分析</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/31/webview/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xixijiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xixijiang的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/31/webview/" itemprop="url">webview</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-31T14:11:44+08:00">
                2019-05-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>webapp: 就是我们现在开发的这些网站<br>nativeapp: 手机自带app</p>
<p>通信机制：</p>
<p>假如在微信中，有个h5页面，需要调用相机，怎么弄呢</p>
<p>方式一:<br>借助于webview，<br>webview向h5注册js代码，比如<br>window.bridge = { photograph: }<br>那么h5就可以这么调用：<br>window.bridge.photograph</p>
<p>window.bridge类似addEventListener</p>
<p>方式二：<br>封装window.prompt方式</p>
<p>方式三：<br>私协：<br>http<br>didi://<br>我们公司内部实现是：把所有功能通过module注册，fusion.js</p>
<p>h5里写：<br>didi://photograph&amp;callDataName=func&amp;callbackDataName=callback<br>photograph是方法，callDataName是从哪里拿参数，callbackDataName回调函数</p>
<p>window.func=function() {return …}必须是个函数，且有返回值<br>window.callback=function() {}是个函数</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/17/人际交往分析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xixijiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xixijiang的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/17/人际交往分析/" itemprop="url">人际交往分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-17T16:54:08+08:00">
                2019-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          The article has been encrypted, please enter your password to view.<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/05/17/人际交往分析/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/17/初识PM/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xixijiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xixijiang的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/17/初识PM/" itemprop="url">初识PM</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-17T16:26:00+08:00">
                2019-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>什么是产品经理？</p>
<p>什么是需求？<br>什么是产品？</p>
<p>需求来源：<br>客户：是购买产品的人<br>用户：是使用产品的人</p>
<p>比如小明买了一瓶水，同时喝了，则他既是客户，也是用户；他买了送给小红，则</p>
<p>收集需求：<br>听用户说：了解目的<br>看用户做：用户做了什么（比如接入魔镜系统）<br>定性分析（为什么点A按钮、不去点B按钮）：了解原因<br>定量分析（有60%点了A按钮、40%点了B按钮）：发现现象<br>（<br>新产品需要先做什么：<br>听用户说<br>定义分析<br>）</p>
<p>整理需求：<br>用户需求：用户自以为是的需求，并且经常表达为用户的解决方案（这种解决方案，可能不可行）<br>-&gt;需求分析-&gt;<br>产品需求: 经错需求分析，找到真实的需求，并且表达为产品的解决方案</p>
<p>需求分析：<br>不要（不可能）满足所有用户的需求<br>产品在不同阶段应该关注不同的用户需求：初期（拉取、保留用户）、后期（付费用户）<br>价值+开发量+优先级综合排序需求</p>
<p>满足需求：<br>提高现实<br>降低理想<br>转移需求</p>
<p>比如电梯的例子</p>
<p>说明需求：<br>给老板看的：<br>BRD: business requirement document<br>MRD: market requirement document</p>
<p>给研发、测试看的：<br>PRD: product requiremnet document<br>FSD: functional specification document</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/15/正则表达式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xixijiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xixijiang的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/15/正则表达式/" itemprop="url">正则表达式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-15T15:15:38+08:00">
                2019-05-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="字符串分割为数组"><a href="#字符串分割为数组" class="headerlink" title="字符串分割为数组"></a>字符串分割为数组</h1>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/13/css技巧/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xixijiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xixijiang的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/13/css技巧/" itemprop="url">css技巧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-13T13:22:57+08:00">
                2019-05-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="两端对齐"><a href="#两端对齐" class="headerlink" title="两端对齐"></a>两端对齐</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// html</span><br><span class="line">&lt;div&gt;姓名&lt;/div&gt;</span><br><span class="line">&lt;div&gt;手机号码&lt;/div&gt;</span><br><span class="line">&lt;div&gt;账号&lt;/div&gt;</span><br><span class="line">&lt;div&gt;密码&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">// css</span><br><span class="line">div &#123;</span><br><span class="line">    margin: 10px 0;</span><br><span class="line">    width: 100px;</span><br><span class="line">    border: 1px solid red;</span><br><span class="line">    text-align: justify;</span><br><span class="line">    text-align-last: justify;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 是为了处理safari浏览器不识别text-align-last:justify;问题（但是这样有个问题，就是会多出一行，不知道有没有什么办法）</span><br><span class="line">// 如果想处理IE兼容性问题，只能使用空格或者&amp;nbsp;</span><br><span class="line">div:after&#123;</span><br><span class="line">    content: &apos;&apos;;</span><br><span class="line">    display: inline-block;</span><br><span class="line">    width: 100%;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="currentColor-—-CSS3超高校级好用CSS变量"><a href="#currentColor-—-CSS3超高校级好用CSS变量" class="headerlink" title="currentColor — CSS3超高校级好用CSS变量"></a>currentColor — CSS3超高校级好用CSS变量</h1><p><code>currentColor</code>：当前的标签所继承的文字颜色</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">div &#123;</span><br><span class="line">  color: red;</span><br><span class="line">  border: 5px solid currentColor;</span><br><span class="line">  box-shadow: 0 0 5px solid currentColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上css实现的效果是边框和阴影与文字颜色相同，都是red。</p>
<p>有什么应用场景呢？</p>
<p>比如，我们有这样一个html:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;##&quot; class=&quot;link&quot;&gt;&lt;i class=&quot;icon icon1&quot;&gt;&lt;/i&gt;返回&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>我们希望hover的时候，icon的颜色与hover设置的颜色相同，这时候就可以这样写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.icon &#123;</span><br><span class="line">    display: inline-block;</span><br><span class="line">    width: 16px; height: 20px;</span><br><span class="line">    background-image: url(../201307/sprite_icons.png);</span><br><span class="line">    background-color: currentColor; /* 该颜色控制图标的颜色 */</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.link:hover &#123; color: #333; &#125;/* 虽然改变的是文字颜色，但是图标颜色也一起变化了 */</span><br></pre></td></tr></table></figure>
<h1 id="实现文字下面波浪线动画效果"><a href="#实现文字下面波浪线动画效果" class="headerlink" title="实现文字下面波浪线动画效果"></a>实现文字下面波浪线动画效果</h1><p>第一步是实现波浪线，有三种办法：</p>
<h2 id="text-decoration-green-wavy-underline"><a href="#text-decoration-green-wavy-underline" class="headerlink" title="text-decoration: green wavy underline;"></a>text-decoration: green wavy underline;</h2><p>text-decoration: green wavy underline;</p>
<p>这种方式有几点问题：</p>
<p><img src="https://github.com/xixizhangfe/markdownImages/blob/master/text-decoration@2x.png?raw=true" alt="text-decoration"></p>
<ol>
<li>线的粗细不好调</li>
<li>字符和装饰线发生重叠的时候，装饰线直接消失了，波浪线变成了一截一截的</li>
<li>无法预知每个波浪线重复片段的宽度，想要无限运动理论上就不太可行</li>
</ol>
<p>因此，文字或者图形的波浪线动画效果不能使用text-decoration的波浪线。</p>
<h2 id="纯css实现-利用radial-gradient"><a href="#纯css实现-利用radial-gradient" class="headerlink" title="纯css实现(利用radial-gradient)"></a>纯css实现(利用radial-gradient)</h2><p>这种方式radial-gradient理解成本高，暂不讨论。</p>
<h2 id="使用SVG波形矢量图作为背景"><a href="#使用SVG波形矢量图作为背景" class="headerlink" title="使用SVG波形矢量图作为背景"></a>使用SVG波形矢量图作为背景</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// css</span><br><span class="line">.underline-wave &#123;</span><br><span class="line">    background: url(&quot;data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 20 4&apos;%3E%3Cpath fill=&apos;none&apos; stroke=&apos;%23333&apos; d=&apos;M0 3.5c5 0 5-3 10-3s5 3 10 3 5-3 10-3 5 3 10 3&apos;/%3E%3C/svg%3E&quot;) repeat-x 0 100%;</span><br><span class="line">    background-size: 20px auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.underline-wave &#123;</span><br><span class="line">    animation: waveMove 1s infinite linear;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@keyframes waveMove &#123;</span><br><span class="line">    from &#123; background-position: 0 100%; &#125;</span><br><span class="line">    to   &#123; background-position: -20px 100%; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// html</span><br><span class="line">&lt;a href=&quot;javascript:&quot; class=&quot;svg-wave&quot;&gt;测试测试测试zhanghhhhha&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>优点是线条边缘平滑，效果细腻，易理解，易上手，易维护。</p>
<p>缺点也很明显，就是波浪线的颜色无法实时跟着文字的颜色发生变化，适用于文字颜色不会多变的场景。</p>
<p>如果我们想要改变波浪线的颜色也很简单，修改background代码中的stroke=’%23333’这部分，’%23’就是就是#，因此，stroke=’%23333’其实就是stroke=’#333’的意思。例如，我们需要改成红色略带橙色，可以stroke=’%23F30’，也可以写完整stroke=’%23FF3300’。</p>
<p>参考：<a href="https://www.zhangxinxu.com/wordpress/2019/04/css-wave-wavy-animation/" target="_blank" rel="noopener">https://www.zhangxinxu.com/wordpress/2019/04/css-wave-wavy-animation/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/07/数据校验/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xixijiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xixijiang的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/07/数据校验/" itemprop="url">数据校验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-07T09:41:56+08:00">
                2019-05-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>对于控制台系统来说，最常用的就是表单了。而表单是需要校验的，有时候写个正则，搞半天都不对，特此记录下来，方便查找。</p>
<h2 id="校验字符串是否是JSON格式"><a href="#校验字符串是否是JSON格式" class="headerlink" title="校验字符串是否是JSON格式"></a>校验字符串是否是JSON格式</h2><p>首先，自然想到的是使用<code>JSON.parse(str)</code>，但是单纯的使用<code>JSON.parse(str)</code>不能完全检验一个字符串是JSON格式，有许多例外：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JSON.parse(&apos;&quot;aaa&quot;&apos;); // aaa</span><br><span class="line">JSON.parse(&apos;123&apos;); // 123</span><br><span class="line">JSON.parse(&apos;true&apos;); // true</span><br><span class="line">JSON.parse(&apos;false&apos;); // false</span><br><span class="line">JSON.parse(&apos;[&quot;a&quot;]&apos;); // [&quot;a&quot;]</span><br><span class="line">JSON.parse(&apos;&#123;&#125;&apos;); // &#123;&#125;</span><br><span class="line">JSON.parse(&apos;null&apos;); // null</span><br></pre></td></tr></table></figure>
<p>JS数据类型有字符串、数字、布尔值、数组、对象、Null、Undefined，经过测试，使用<code>JSON.parse</code>能够转换成功的有：数字、字符串、布尔值、数组、空对象、null、json，而其中正确的JSON格式有：数组、空对象、json</p>
<p>所以，得出结论，如果<code>JSON.parse</code>能够转换成功，并且转换后的类型为object，且不等于null，那么这个字符串就是JSON格式的字符串。</p>
<p>所以代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function isJSON(str) &#123;</span><br><span class="line">    if (typeof str === &apos;string&apos;) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            var obj = JSON.parse(str);</span><br><span class="line">            if(typeof obj === &apos;object&apos; &amp;&amp; obj )&#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; catch(e) &#123;</span><br><span class="line">            console.log(&apos;error：&apos;+str+&apos;!!!&apos;+e);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    console.log(&apos;It is not a string!&apos;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考资料：<a href="https://www.cnblogs.com/lanleiming/p/7096973.html" target="_blank" rel="noopener">https://www.cnblogs.com/lanleiming/p/7096973.html</a></p>
<h2 id="数字相关"><a href="#数字相关" class="headerlink" title="数字相关"></a>数字相关</h2><p>这里经常犯的错误是，<code>\d{0, 7}</code>经常错写成<code>\d{0-7}</code></p>
<h3 id="非负整数"><a href="#非负整数" class="headerlink" title="非负整数"></a>非负整数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^\d+$/</span><br></pre></td></tr></table></figure>
<h3 id="正整数"><a href="#正整数" class="headerlink" title="正整数"></a>正整数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^[1-9]&#123;1&#125;(\d+)?$/g</span><br></pre></td></tr></table></figure>
<h3 id="整数"><a href="#整数" class="headerlink" title="整数"></a>整数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^-?\d+$/</span><br></pre></td></tr></table></figure>
<h3 id="限制范围的整数"><a href="#限制范围的整数" class="headerlink" title="限制范围的整数"></a>限制范围的整数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 1-100之间的整数</span><br><span class="line">/^([1-9]&#123;1&#125;\d?|100)$/g</span><br></pre></td></tr></table></figure>
<h3 id="数字"><a href="#数字" class="headerlink" title="数字"></a>数字</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^(\.\d+)|(-?\d+(\.\d*)?)$/</span><br></pre></td></tr></table></figure>
<h3 id="限制小数位数"><a href="#限制小数位数" class="headerlink" title="限制小数位数"></a>限制小数位数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^-?\d+(\.\d&#123;0,7&#125;)?$/</span><br></pre></td></tr></table></figure>
<h2 id="字符串相关"><a href="#字符串相关" class="headerlink" title="字符串相关"></a>字符串相关</h2><h3 id="大小写字母、数字、下划线、中划线"><a href="#大小写字母、数字、下划线、中划线" class="headerlink" title="大小写字母、数字、下划线、中划线"></a>大小写字母、数字、下划线、中划线</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^[a-zA-Z0-9_-]+$/g</span><br></pre></td></tr></table></figure>
<h3 id="限制字符串长度"><a href="#限制字符串长度" class="headerlink" title="限制字符串长度"></a>限制字符串长度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 只能输入64个字符</span><br><span class="line">/^.&#123;1,64&#125;$/g</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/06/js模块系统详解-二/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xixijiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xixijiang的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/06/js模块系统详解-二/" itemprop="url">js模块系统详解(二)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-06T09:26:27+08:00">
                2019-05-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="各个模块系统的语法"><a href="#各个模块系统的语法" class="headerlink" title="各个模块系统的语法"></a>各个模块系统的语法</h2><p>CommonJS的语法是<code>require</code> <code>module.exports</code></p>
<p>ES6的语法是<code>import</code> <code>export</code> <code>export default</code></p>
<p>NodeJS的语法是<code>require</code> <code>exports</code> <code>module.exports</code></p>
<h2 id="require-import-export-module-exports混用"><a href="#require-import-export-module-exports混用" class="headerlink" title="require import export module.exports混用"></a><code>require</code> <code>import</code> <code>export</code> <code>module.exports</code>混用</h2><p>通常我们所做的项目，会遇到<code>require</code> <code>import</code> <code>export</code> <code>module.exports</code>混合使用的情况。</p>
<p>比如，我所做的一个项目使用了node，在node层schema.js里导出了一个属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// schema.js</span><br><span class="line">exports.rules = &#123;</span><br><span class="line">  name: [&#123;</span><br><span class="line">    pattern: /\w+/,</span><br><span class="line">    message: &apos;支持英文字母、数字、下划线&apos;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    min: 4,</span><br><span class="line">    max: 32,</span><br><span class="line">    message: &apos;长度范围必须在4~32字符之间&apos;,</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后，在前端vue文件里引入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// test.vue</span><br><span class="line">import &#123; rules &#125; from &apos;/path/to/schema.js&apos;;</span><br></pre></td></tr></table></figure>
<p>对于nodejs模块规范来说，使用exports导出，应该使用require引入。而上面这个例子，是import引入的。那么为什么可以这样做？</p>
<p>这里我看到了一篇文章，非常好，<a href="https://juejin.im/post/5a2e5f0851882575d42f5609，推荐给大家。下面的内容，也都是抄的这篇文章的。目的是为了加深自己的记忆与理解。" target="_blank" rel="noopener">https://juejin.im/post/5a2e5f0851882575d42f5609，推荐给大家。下面的内容，也都是抄的这篇文章的。目的是为了加深自己的记忆与理解。</a></p>
<p>链接的文章主要从这几个问题入手：</p>
<ol>
<li>为什么有的地方使用<code>require</code>去引用一个模块时需要加上<code>default</code>？<code>require(&#39;xx&#39;).default</code></li>
<li>经常在各大UI组件引用的文档上会看到说明<code>import { button } from &#39;xx-ui&#39;</code>这样会引入所有组件内容，需要添加额外的babel配置，比如<code>babel-plugin-component</code>?</li>
<li>为什么可以使用es6的import去引用commonjs规范定义的模块，或者反过来也可以？</li>
<li>我们在浏览一些npm下载下来的UI组件模块时（比如说element-ui的lib文件夹下），看到的都是webpack编译好的js文件，可以使用import或require再去引用。但是我们平时编译好的js是无法再被其他模块import的，这是为什么？</li>
<li>babel在模块化的场景中充当了什么角色？以及webpack？哪个起到了关键作用？</li>
<li>听说es6还有tree-shaking功能，怎么才能使用这个功能？</li>
</ol>
<h3 id="webpack在模块化中的作用"><a href="#webpack在模块化中的作用" class="headerlink" title="webpack在模块化中的作用"></a>webpack在模块化中的作用</h3><p>webpack本身维护了一套模块系统，这套模块系统兼容了所有前端历史进程下的模块规范，包括<code>amd</code> <code>commonjs</code> <code>es6</code>等。下面只对<code>commonjs</code> <code>es6</code>规范进行说明。</p>
<p>模块化的实现其实就在最后编译的文件内。</p>
<p>先看一下这个demo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// webpack</span><br><span class="line"></span><br><span class="line">const path = require(&apos;path&apos;);</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">  entry: &apos;./main.js&apos;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, &apos;dist&apos;),</span><br><span class="line">    filename: &apos;bundle.js&apos;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// main.js</span><br><span class="line">import a from &apos;./a&apos;;</span><br><span class="line"></span><br><span class="line">export default a;</span><br><span class="line">console.log(a);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// a.js</span><br><span class="line"></span><br><span class="line">export default 333;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// webpack编译后的js</span><br><span class="line"></span><br><span class="line">(function(modules) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  function __webpack_require__(moduleId) &#123;</span><br><span class="line">    var module =  &#123;</span><br><span class="line">      i: moduleId,</span><br><span class="line">      l: false,</span><br><span class="line">      exports: &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);</span><br><span class="line">    return module.exports;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return __webpack_require__(0);</span><br><span class="line">&#125;)(&#123;</span><br><span class="line">  &quot;./client/a.js&quot;:</span><br><span class="line">  (function (module, __webpack_exports__, __webpack_require__) &#123;</span><br><span class="line"></span><br><span class="line">    &quot;use strict&quot;;</span><br><span class="line">    Object.defineProperty(exports, &apos;__esModule&apos;, &#123; value: true &#125;);</span><br><span class="line">    /* harmony default export */ __webpack_exports__[&quot;default&quot;] = (333);</span><br><span class="line">  &#125;),</span><br><span class="line">  &quot;./client/main.js&quot;:</span><br><span class="line">  (function (module, __webpack_exports__, __webpack_require__) &#123;</span><br><span class="line"></span><br><span class="line">    &quot;use strict&quot;;</span><br><span class="line">    Object.defineProperty(exports, &apos;__esModule&apos;, &#123; value: true &#125;);</span><br><span class="line">    /* harmony import */ var _a_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./a.js */ &quot;./client/a.js&quot;);</span><br><span class="line">    /* harmony default export */ __webpack_exports__[&quot;default&quot;] = (&apos;main.js&apos;);</span><br><span class="line">    console.log(&apos;a&apos;, _a_js__WEBPACK_IMPORTED_MODULE_0__[&quot;default&quot;]);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上面这段js就是使用webpack编译后的代码（经过精简），其中就包含了webpack的运行时代码，就是关于模块的实现。</p>
<p>其实这段js就是一个自执行函数，这个函数的入参是个对象（注意原文可能由于webpack版本问题，写的是数组。本文用的是webpack4），对象的内容包括了所有依赖的模块。</p>
<p>自执行逻辑相信大家都知道。那么最关键的，也是与require、import有关的，是<code>__webpack_require__</code>这个函数。它是<code>require</code>或者<code>import</code>的替代。而<code>__webpack_exports__</code>就是模块的<code>module.exports</code>的引用。比如，入口模块中调用了<code>__webpack_require__(1)</code>, 那么就会得到1这个模块的<code>module.exports</code>。</p>
<p>注意上面的例子，我们都是采用es6的规范，如果把引入的方式改成commonjs呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// main.js</span><br><span class="line">let a = require(&apos;./a.js&apos;);</span><br><span class="line"></span><br><span class="line">export default a;</span><br><span class="line">console.log(a);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// webpack编译后的js</span><br><span class="line"></span><br><span class="line">(function(modules) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  function __webpack_require__(moduleId) &#123;</span><br><span class="line">    var module =  &#123;</span><br><span class="line">      i: moduleId,</span><br><span class="line">      l: false,</span><br><span class="line">      exports: &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);</span><br><span class="line">    return module.exports;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return __webpack_require__(0);</span><br><span class="line">&#125;)(&#123;</span><br><span class="line">  &quot;./client/a.js&quot;:</span><br><span class="line">  (function (module, __webpack_exports__, __webpack_require__) &#123;</span><br><span class="line"></span><br><span class="line">    &quot;use strict&quot;;</span><br><span class="line">    Object.defineProperty(exports, &apos;__esModule&apos;, &#123; value: true &#125;);</span><br><span class="line">    /* harmony default export */ __webpack_exports__[&quot;default&quot;] = (333);</span><br><span class="line">  &#125;),</span><br><span class="line">  &quot;./client/main.js&quot;:</span><br><span class="line">  (function (module, __webpack_exports__, __webpack_require__) &#123;</span><br><span class="line"></span><br><span class="line">    &quot;use strict&quot;;</span><br><span class="line">    Object.defineProperty(exports, &apos;__esModule&apos;, &#123; value: true &#125;);</span><br><span class="line">    let a = __webpack_require__(/*! ./a.js */ &quot;./client/a.js&quot;);</span><br><span class="line">    /* harmony default export */ __webpack_exports__[&quot;default&quot;] = (&apos;main.js&apos;);</span><br><span class="line">    console.log(&apos;a&apos;, a);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>此时，发现编译后的结果少了把a.js转换的过程，</p>
<p><code>/* harmony import */ var _a_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./a.js */ &quot;./client/a.js&quot;);</code></p>
<p>变成了</p>
<p><code>let a = __webpack_require__(/*! ./a.js */ &quot;./client/a.js&quot;);</code></p>
<p>这说明，webpack在模块化时如果发现是es6规范，就会通过<strong>webpack</strong>require将其转成webpack规范。</p>
<p>目前这种编译后的js，将入口模块的输出(即<code>module.exports</code>)进行输出没有任何作用，只会作用于当前作用域。这个js并不能被其他模块继续以<code>require</code>或<code>import</code>的方式引用。</p>
<h3 id="babel的作用"><a href="#babel的作用" class="headerlink" title="babel的作用"></a>babel的作用</h3><p>webpack的模块化方案是把es6模块化转换成webpack的模块化，但是其余的es6语法还需要做兼容性处理。babel专门用于处理es6转换es5。当然这也包括es6的模块语法的转换。</p>
<p>其实两者的转换思路差不多，区别在于webpack的原生转换 可以多做一步静态分析，使用tree-shaking技术（下面会讲到）</p>
<p>babel能提前将es6的import等模块关键字转换成commonjs的规范。这样webpack就无需再做处理，直接使用webpack运行时定义的<strong>webpack_require</strong>处理。</p>
<p>这里就解释了问题5。</p>
<p>babel是如何转换es6模块的？</p>
<h4 id="导出模块"><a href="#导出模块" class="headerlink" title="导出模块"></a>导出模块</h4><p>es6的导出模块写法有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export default 123;</span><br><span class="line"></span><br><span class="line">export const a = 123;</span><br><span class="line"></span><br><span class="line">const b = 3;</span><br><span class="line">const c = 4;</span><br><span class="line">export &#123; b, c &#125;;</span><br></pre></td></tr></table></figure>
<p>babel会将这些统统转成commonjs的exports:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exports.default = 123;</span><br><span class="line">exports.a = 123;</span><br><span class="line">exports.b = 3;</span><br><span class="line">exports.c = 4;</span><br><span class="line">exports.__esModule = true;</span><br></pre></td></tr></table></figure>
<p>babel转换es6的模块输出逻辑非常简单，即将所有输出都赋值给exports，并带上一个__esModule表明这是个由es6转换来的commonjs输出。</p>
<p>同样，对于import，也会转成require。</p>
<h4 id="引入default"><a href="#引入default" class="headerlink" title="引入default"></a>引入default</h4><p>对于最常见的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import a from &apos;./a.js&apos;;</span><br></pre></td></tr></table></figure>
<p>es6的本意是引入<code>a.js</code>里的default输出，但是转成commonjs后，<code>var a = require(&#39;./a.js&#39;)</code>得到的是整个对象，不是es6的本意，所以需要对a进行处理。</p>
<p>我们在导出中提到，default输出会赋值给导出对象的default属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exports.default = 123;</span><br></pre></td></tr></table></figure>
<p>所以babel加了个help <code>_interopRequireDefault</code>函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function _interopRequireDefault(obj) &#123;</span><br><span class="line">    return obj &amp;&amp; obj.__esModule</span><br><span class="line">        ? obj</span><br><span class="line">        : &#123; &apos;default&apos;: obj &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var _a = require(&apos;assert&apos;);</span><br><span class="line">var _a2 = _interopRequireDefault(_a);</span><br><span class="line"></span><br><span class="line">var a = _a2[&apos;default&apos;];</span><br></pre></td></tr></table></figure>
<p>所以这里最后的a变量就是require的值的default属性。如果原先就是commonjs规范，那么a就是那个模块的导出对象。</p>
<h4 id="引入-通配符"><a href="#引入-通配符" class="headerlink" title="引入*通配符"></a>引入*通配符</h4><p>es6使用<code>import * as a from &#39;./a.js&#39;</code>的本意是将es6模块的所有命名输出以及default输出打包成一个对象赋值给a变量。</p>
<p>而通过<code>var a = require(&#39;./a.js&#39;)</code>就能实现上述意图。</p>
<p>所以直接返回这个对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (obj &amp;&amp; obj.__esModule) &#123;</span><br><span class="line">   return obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果本来就是commonjs规范，导出时没有default属性，需要添加一个default属性，并把整个模块对象再次赋值给default属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function _interopRequireWildcard(obj) &#123;</span><br><span class="line">    if (obj &amp;&amp; obj.__esModule) &#123;</span><br><span class="line">        return obj;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        var newObj = &#123;&#125;; // (A)</span><br><span class="line">        if (obj != null) &#123;</span><br><span class="line">            for (var key in obj) &#123;</span><br><span class="line">                if (Object.prototype.hasOwnProperty.call(obj, key))</span><br><span class="line">                    newObj[key] = obj[key];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        newObj.default = obj;</span><br><span class="line">        return newObj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以<code>import { a } from &#39;./a.js&#39;</code>直接换成<code>require(&#39;./a.js&#39;).a</code>即可。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>即使我们使用了es6的模块系统，如果借助babel的转换，es6的模块系统最终还是会转换成commonjs的规范。所以，如果我们是使用babel转换es6模块，混合使用es6的模块和commonjs的规范是没有问题的，因为最终都会转换成commonjs。</p>
<p>这里就解释了问题3。</p>
<h3 id="babel5-amp-babel6"><a href="#babel5-amp-babel6" class="headerlink" title="babel5 &amp; babel6"></a>babel5 &amp; babel6</h3><p>es6的<code>export default</code>都会被转换成exports.default，即使这个模块只有这一个输出。</p>
<p>我们现在再把<code>main.js</code>改一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// main.js</span><br><span class="line"></span><br><span class="line">import a from &apos;./a.js&apos;;</span><br><span class="line">let a2 = require(&apos;./a.js&apos;);</span><br><span class="line"></span><br><span class="line">export default &apos;main.js&apos;;</span><br><span class="line"></span><br><span class="line">console.log(&apos;a&apos;, a);</span><br><span class="line">console.log(&apos;a2&apos;, a2);</span><br></pre></td></tr></table></figure>
<p>会发现，打印出来的内容是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">333</span><br><span class="line">Module &#123;default: 333, __esModule: true, Symbol(Symbol.toStringTag): &quot;Module&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>会发现，通过<code>require</code>引入es6模块，得到的是整个对象，这时候需要<code>require(&#39;./a.js&#39;).default</code>得到想要的结果。</p>
<p>这里就解释了问题1。</p>
<p>在babel5时代，大部分人在用require去引用es6输出的default，只是把default输出看做是一个模块的默认输出，所以babel5对这个逻辑做了hack，如果一个es6模块只有一个default输出，那么在转换成commonjs的时候也一起赋值给module.exports，即整个导出对象被赋值了default所对应的值。这样就不需要加default。</p>
<p>但这样做是不符合es6的定义的，在es6的定义里，default只是个名字，没有任何意义。</p>
<h3 id="webpack编译后的js，如何再被其他模块引用"><a href="#webpack编译后的js，如何再被其他模块引用" class="headerlink" title="webpack编译后的js，如何再被其他模块引用"></a>webpack编译后的js，如何再被其他模块引用</h3><p>通过配置output.libraryTarget指定构建完的js的用途。</p>
<h4 id="默认var"><a href="#默认var" class="headerlink" title="默认var"></a>默认var</h4><p>如果指定了<code>output.library = &#39;test&#39;</code>，入口模块返回的module.exports暴露给全局<code>var test = returned_module_exports</code></p>
<h4 id="commonjs"><a href="#commonjs" class="headerlink" title="commonjs"></a>commonjs</h4><p>如果library: ‘spon-ui’入口模块返回的module.exports赋值给<code>exports[&#39;spon-ui&#39;]</code></p>
<h4 id="commonjs2"><a href="#commonjs2" class="headerlink" title="commonjs2"></a>commonjs2</h4><p>入口模块返回的module.exports 赋值给module.exports</p>
<p>所以element-ui的构建方式采用commonjs2，导出的组件的js最后都会赋值给module.exports，供其他模块引用。</p>
<p>这就解释了问题4</p>
<h2 id="模块依赖的优化"><a href="#模块依赖的优化" class="headerlink" title="模块依赖的优化"></a>模块依赖的优化</h2><h3 id="按需加载的原理"><a href="#按需加载的原理" class="headerlink" title="按需加载的原理"></a>按需加载的原理</h3><p>我们在使用各大 UI 组件库时都会被介绍到为了避免引入全部文件，请使用<code>babel-plugin-component</code>等babel 插件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#123; Button, Select &#125; from &apos;element-ui&apos;</span><br></pre></td></tr></table></figure>
<p>由前文可知，import会先转换为commonjs。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var a = require(&apos;element-ui&apos;);</span><br><span class="line">var Button = a.Button;</span><br><span class="line">var Select = a.Select;</span><br></pre></td></tr></table></figure>
<p><code>var a = require(&#39;element-ui&#39;);</code> 这个过程就会将所有组件都引入进来了。</p>
<p>所以<code>babel-plugin-component</code>就做了一件事，将<code>import { Button, Select } from &#39;element-ui&#39;</code>转换成了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import Button from &apos;element-ui/lib/button&apos;</span><br><span class="line">import Select from &apos;element-ui/lib/select&apos;</span><br></pre></td></tr></table></figure>
<p>即使转换成了commonjs规范，也只是引入自己这个组件的js，将引入量减少到最低。</p>
<p>这里解释了问题2</p>
<h3 id="tree-shaking"><a href="#tree-shaking" class="headerlink" title="tree-shaking"></a>tree-shaking</h3><p>这个就直接看原文吧。</p>
<p>参考链接<a href="https://juejin.im/post/5a2e5f0851882575d42f5609" target="_blank" rel="noopener">https://juejin.im/post/5a2e5f0851882575d42f5609</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="xixijiang">
          <p class="site-author-name" itemprop="name">xixijiang</p>
           
              <p class="site-description motion-element" itemprop="description">切莫停下前进的脚步</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">66</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">categories</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xixijiang</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
